# Insert Data
- The INSERT statement is used to add one or more rows to a table. There are several forms of the statement.

```sql
INSERT [INTO] <Table> [(column_list)]
VALUES ([ColumnName or an expression or DEFAULT or NULL],…n)
```

- The column_list is optional but recommended. Without the column_list, the INSERT statement will expect a value for every column in the table in the order in which the columns were defined.
- The VALUES clause is required and must contain a value for every column in the table or a DEFAULT or NULL value.
  - Default values are used when a column is not specified in the column_list and the column has a default value defined.
  - We can predefine the default value with some ways;
    - If a column has been defined to have an automatically generated value, that value will be used. Autogenerated values will be discussed later in this module.
    - When a table is created, a default value can be supplied for a column, and that value will be used if DEFAULT is specified.
    - If a column has been defined to allow NULL values, and the column isn't an autogenerated column and doesn't have a default defined, NULL will be inserted as a DEFAULT.


```tsql
-- We insert a new row into the Sales.Promotion table with the specified column names.
INSERT INTO Sales.Promotion (PromotionName,StartDate,ProductModelID,Discount,Notes)
VALUES
('Clearance Sale', '01/01/2021', 23, 0.1, '10% discount');

-- We insert a new row into the Sales.Promotion table without specifying the column names.
INSERT INTO Sales.Promotion
VALUES
('Clearance Sale', '01/01/2021', 23, 0.1, '10% discount');

-- We insert a new row with specified DEFAULT value for start date, and NULL for notes.
-- Default value for start date is current date.
INSERT INTO Sales.Promotion
VALUES
('Pull your socks up', DEFAULT, 24, 0.25, NULL);


-- We don't have to specify the all columns in the table.
INSERT INTO Sales.Promotion (PromotionName, ProductModelID, Discount)
VALUES
('Caps Locked', 2, 0.2);

-- We can insert multiple rows in a single INSERT statement.
INSERT INTO Sales.Promotion
VALUES
('The gloves are off!', DEFAULT, 3, 0.25, NULL),
('The gloves are off!', DEFAULT, 4, 0.25, NULL);
```

## Insert ... Select

- In addition to the **INSERT** statement, there are other ways to insert data into a table. 
- One of the most common ways is to use the **SELECT** statement to insert data from one table into another.
- You can use the results of a SELECT statement or the output of a stored procedure (INSERT EXEC) to supply the values for the INSERT statement.

You may optionally specify a column list following the table name.
You must provide column values or DEFAULT, or NULL, for each column.

```tsql
INSERT [INTO] <table or view> [(column_list)]
SELECT <column_list> FROM <table_list>...;
```

```tsql
-- Select the data from the Production.ProductModel table where the Name column contains the word 'frame'.
-- Insert the data into the Sales.Promotion table with some additional data.
INSERT INTO Sales.Promotion (PromotionName, ProductModelID, Discount, Notes)
SELECT DISTINCT 'Get Framed', m.ProductModelID, 0.1, '10% off ' + m.Name
FROM Production.ProductModel AS m
WHERE m.Name LIKE '%frame%';
```


## Select ... Into
- The **SELECT INTO** statement is used to create a new table and insert the results of a SELECT statement into it.
- The new table will be created with the same column names and data types as the columns in the SELECT statement.

```tsql
-- Create a new table called Sales.Invoice and insert the data from the Sales.SalesOrderHeader table.
-- The new table will have the same columns, same data types, and the same data as the Sales.SalesOrderHeader table.

SELECT SalesOrderID, CustomerID, OrderDate, PurchaseOrderNumber, TotalDue
INTO Sales.Invoice
FROM Sales.SalesOrderHeader;
```


# Generate Automatic Values
- You may need to automatically generate sequential values for one column in a specific table.
- You can use the **IDENTITY** property to automatically generate values for a column.
- You can define a **SEQUENCE** object and use values generated by that object.

## Identity Property
- The **IDENTITY** property is used to automatically generate values for a column.
- The **IDENTITY** property can be applied to a column of a numeric data type.
- Identity property can not work multiple columns or multiple tables.
- This property take two arguments;
  - **Seed** - The first value that will be generated with this property.
  - **Increment** - The value that will be added to the previous value to generate the next value.

```tsql
CREATE TABLE Sales.Promotion
(
  PromotionID int IDENTITY PRIMARY KEY,
  PromotionName varchar(20),
  StartDate datetime NOT NULL DEFAULT GETDATE(),
  ProductModelID int NOT NULL REFERENCES Production.ProductModel(ProductModelID),
  Discount decimal(4,2) NOT NULL,
  Notes nvarchar(max) NULL
);

INSERT INTO Sales.Promotion
VALUES
('Clearance Sale', '01/01/2021', 23, 0.10, '10% discount')

SELECT * FROM Sales.Promotion;
```

| PromotionID | PromotionName   | StartDate  | ProductModelID | Discount | Notes        |
|-------------|-----------------|------------|----------------|----------|--------------|
| 1           | Clearance Sale  | 2021-01-01 | 23             | 0.10     | 10% discount |

### Scope Identity

- The SCOPE_IDENTITY function returns the most recent identity value generated in the current scope for any table.
```tsql
SELECT SCOPE_IDENTITY();
```

| (No column name) |
|------------------|
| 1                |


### Ident Current

- If you need the latest identity value in a specific table
```tsql
SELECT IDENT_CURRENT('Sales.Promotion');
```

| (No column name) |
|------------------|
| 1                |


### Overriding Identity Values
- If you want to override the automatically generated value and assign a specific value to the IDENTITY column, you first need to enable identity inserts by using the SET IDENTITY INSERT table_name ON statement.

```tsql
SET IDENTITY_INSERT Sales.Promotion ON;

INSERT INTO Sales.Promotion (PromotionID, PromotionName, StartDate, ProductModelID, Discount, Notes)
VALUES
(100, 'Clearance Sale', '01/01/2021', 23, 0.10, '10% discount');

SET IDENTITY_INSERT Sales.Promotion OFF;
```


### Reseeding Identity Values

- If you want to reset the identity value to a specific value or skip identity values, you can use the DBCC CHECKIDENT command.
```tsql
DBCC CHECKIDENT ('Sales.Promotion', RESEED, 1);
```

> Details: https://learn.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql?view=sql-server-ver16










## Sequence
- In Transact-SQL, you can use a sequence object to define new sequential values independently of a specific table.
- For instance, we have 2 table for orders. But We want unique primary key for both tables. We can use sequence object for this purpose.

```tsql
-- Create a sequence object called InvoiceNumber that starts at 1000 and increments by 1.
CREATE SEQUENCE Sales.InvoiceNumber AS INT
START WITH 1000 INCREMENT BY 1;
```

- You can use the NEXT VALUE FOR function to get the next value from the sequence object.
- When we called the NEXT VALUE FOR function, the sequence object will be incremented by the increment value.
```tsql
INSERT INTO Sales.ResellerInvoice
VALUES
(NEXT VALUE FOR Sales.InvoiceNumber, 2, GETDATE(), 'PO12345', 107.99);

SELECT * FROM Sales.ResellerInvoice;
```

| InvoiceID | CustomerID | InvoiceDate | PurchaseOrderNumber | TotalDue |
|-----------|------------|-------------|---------------------|----------|
| 1000      | 2          | 2021-01-01  | PO12345             | 107.99   |

- You can reset the sequence object to a specific value by using the ALTER SEQUENCE statement.
```tsql
ALTER SEQUENCE Sales.InvoiceNumber RESTART WITH 1000;
```

> Details: https://learn.microsoft.com/en-us/sql/t-sql/statements/alter-sequence-transact-sql?view=sql-server-ver16



```tsql
SELECT NEXT VALUE FOR dbo.Sequence OVER (ORDER BY Name) AS NextID,
    ProductID,
    Name
FROM Production.Product;

SELECT  ROW_NUMBER() over (ORDER BY Name) AS NextID,
    ProductID,
    Name
FROM Production.Product;
```

- sp_sequence_get_range is used to get a range of sequence numbers from a sequence object.
- When we call the sp_sequence_get_range stored procedure, the sequence object will be incremented by the range_size value.
- For instance, stayed value is 1000 and increment value is 1. 
- If we call the sp_sequence_get_range stored procedure with the range_size value of 10, the sequence object will be incremented by 10.
- The stored procedure will return the range of sequence numbers from 1000 to 1009.

```tsql
-- This statement gets a range of 10 sequence numbers from the dbo.Sequence sequence object.
EXEC sp_sequence_get_range
    @sequence_name = N'dbo.Sequence',
    @range_size = 10;
``` 









# Update Data
- The UPDATE statement in T-SQL is used to change existing data in a table. 
- UPDATE operates on a set of rows, either defined by a condition in a WHERE clause or defined in a join.
- The UPDATE statement has a SET clause that specifies which columns are to be modified.

```tsql
UPDATE <TableName>
SET 
<ColumnName> = { expression | DEFAULT | NULL }
{,…n}
WHERE <search_conditions>;
```

```tsql
UPDATE Sales.Promotion
SET Notes = '25% off socks'
WHERE PromotionID = 2;

-- We can update multiple columns in a single UPDATE statement.
-- We can use functions in the SET clause. (REPLACE is change second parameter with third parameter in the first parameter)
UPDATE Sales.Promotion
SET Discount = 0.2, Notes = REPLACE(Notes, '10%', '20%')
WHERE PromotionName = 'Get Framed';
```

- Update supports to use From clause.
```tsql
UPDATE Sales.Promotion
-- Format function is used to format the Discount column as a percentage. (FORMAT(Discount, 'P') => 0.10 => 10%)
SET Notes = FORMAT(Discount, 'P') + ' off ' + m.Name
FROM Product.ProductModel AS m
WHERE Notes IS NULL
    AND Sales.Promotion.ProductModelID = m.ProductModelID;
```


# Delete Data
- DELETE operates on a set of rows, either defined by a condition in a WHERE clause or defined in a join. 
- The WHERE clause in a DELETE statement has the same structure as a WHERE clause in a SELECT statement.

```tsql
DELETE [FROM] <TableName>
WHERE <search_conditions>;
```

```tsql
DELETE FROM Production.Product
WHERE discontinued = 1;

-- We can use the FROM clause to delete rows from a table based on a join.
DELETE p
FROM Sales.Promotion p
JOIN Production.ProductModel AS m
ON p.ProductModelID = m.ProductModelID
WHERE m.Name LIKE '%frame%';
```

## Truncate Table
- The TRUNCATE TABLE statement is used to remove all rows from a table.

```tsql
TRUNCATE TABLE Sales.Sample;
```










# Merge Data Based on multiple tables
- This DML option allows you to synchronize two tables by inserting, updating, or deleting rows in one table based on differences found in the other table.
- MERGE modifies data, based on one or more conditions:
  - When the source data has a matching row in the target table, it can update data in the target table.
    - WHEN MATCHED THEN
  - When the source data has no match in the target, it can insert data into the target table.
    - WHEN NOT MATCHED [BY TARGET] THEN
  - When the target data has no match in the source, it can delete the target data.
    - WHEN NOT MATCHED BY SOURCE THEN

```tsql
MERGE INTO schema_name.table_name AS TargetTbl
USING (SELECT <select_list>) AS SourceTbl
ON (TargetTbl.col1 = SourceTbl.col1)
WHEN MATCHED THEN 
   UPDATE SET TargetTbl.col2 = SourceTbl.col2
WHEN NOT MATCHED [BY TARGET] THEN
   INSERT (<column_list>)
   VALUES (<value_list>)
WHEN NOT MATCHED BY SOURCE THEN
   DELETE;
```

---

- You can use only the elements of the MERGE statement that you need.

```tsql
MERGE INTO Sales.Invoice as i
USING Sales.ResellerInvoice as s
ON (i.SalesOrderID = s.SalesOrderID)
WHEN MATCHED THEN
  UPDATE SET i.CustomerID = s.CustomerID,
             i.OrderDate = GETDATE(),
             i.PurchaseOrderNumber = s.PurchaseOrderNumber,
             i.TotalDue = s.TotalDue
WHEN NOT MATCHED BY TARGET THEN -- BY TARGET is optional
    INSERT (SalesOrderID, CustomerID, OrderDate, PurchaseOrderNumber, TotalDue)
    VALUES (s.SalesOrderID, s.CustomerID, s.OrderDate, s.PurchaseOrderNumber, s.TotalDue)
--WHEN NOT MATCHED BY SOURCE THEN
--    DELETE;
```